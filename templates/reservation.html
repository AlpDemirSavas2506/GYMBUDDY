{% extends "base.html" %}
{% block title %}Reservation - GymBuddy{% endblock %}
{% block content %}
<div class="reservation-container">
    <h1 class="heading">Make a Reservation</h1>
    <p>Select a facility and a date to view available slots.</p>

    <!-- Facility and Date Selection Form -->
    <form id="reservation-form" method="POST">
        <div class="form-group">
            <label for="facility">Facility:</label>
            <select id="facility" name="facility_id" class="form-control" required>
                <option value="" disabled selected>Select a facility</option>
                {% for facility in facilities %}
                <option value="{{ facility.id }}">{{ facility.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="date">Date:</label>
            <input type="date" id="date" name="date" class="form-control" required>
        </div>

        <button type="button" id="fetch-slots" class="btn btn-primary">View Available Slots</button>
    </form>

    <!-- Available Slots -->
    <div id="slots-container" style="display: none;">
        <h2>Available Time Slots</h2>
        <div id="slots" class="slots-grid">
            <!-- Slots will be dynamically loaded here -->
        </div>
    </div>
</div>

<style>
/* General grid layout */
.slots-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

/* Slot cards */
.slot {
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

/* Available slot styling */
.slot.available {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

/* Unavailable slot styling */
.slot.unavailable {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    pointer-events: none; /* Make unavailable slots unclickable */
}

/* Hover effect */
.slot:hover {
    transform: scale(1.05);
}

/* Username styling for unavailable slots */
.slot .username {
    font-size: 12px;
    font-weight: normal;
    color: #555;
    margin-top: 5px;
}
</style>

<script>
document.getElementById('fetch-slots').addEventListener('click', async () => {
    const facilityId = document.getElementById('facility').value;
    const date = document.getElementById('date').value;

    if (!facilityId || !date) {
        alert("Please select a facility and a date.");
        return;
    }

    const response = await fetch(`/reservation?facility_id=${facilityId}&date=${date}`);
    const data = await response.json();

    const slotsContainer = document.getElementById('slots-container');
    const slotsGrid = document.getElementById('slots');
    slotsGrid.innerHTML = ''; // Clear existing slots

    if (data.available_slots && data.available_slots.length > 0) {
        slotsContainer.style.display = 'block';

        data.available_slots.forEach(slot => {
            const div = document.createElement('div');
            div.className = `slot ${slot.available ? 'available' : 'unavailable'}`;
            div.textContent = `${new Date(slot.start_time).toLocaleTimeString()} - ${new Date(slot.end_time).toLocaleTimeString()}`;

            // Add username if the slot is unavailable
            if (!slot.available && slot.username) {
                const usernameDiv = document.createElement('div');
                usernameDiv.className = 'username';
                usernameDiv.textContent = `Reserved by: ${slot.username}`;
                div.appendChild(usernameDiv);
            }

            // Make available slots clickable
            if (slot.available) {
                div.onclick = () => reserveSlot(facilityId, slot.start_time, slot.end_time);
            }

            slotsGrid.appendChild(div);
        });
    } else {
        slotsGrid.innerHTML = '<p>No available slots found.</p>';
    }
});

async function reserveSlot(facilityId, startTime, endTime) {
    const confirmReservation = confirm(`Do you want to reserve this slot?`);
    if (confirmReservation) {
        const response = await fetch('/reservation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ facility_id: facilityId, start_time: startTime, end_time: endTime })
        });

        if (response.ok) {
            alert("Reservation successful!");
            location.reload();
        } else {
            alert("Failed to reserve slot.");
        }
    }
}
</script>
{% endblock %}
